<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head><title>Lista de Filmes</title>

        <link th:if="${css == 'claro'}" rel="stylesheet" th:href="@{/css/claro.css}" />
        <link th:if="${css == 'escuro'}" rel="stylesheet" th:href="@{/css/escuro.css}" />

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
        <link th:href="@{'/css/' + ${css} + '.css'}" rel="stylesheet" type="text/css"/>
    </head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
        }
        .modal-header {
            background-color: #0d6efd;
            color: white;
        }
    </style>
    <body>

        <div class="container mt-5">
            <h1 class="text-center mb-4">Lista de Filmes</h1>

            <form th:action="@{/filmes/preferencias}" method="post">
                <label for="selEstilo">Escolha o tema:</label>
                <select name="estilo" id="selEstilo">
                    <option value="claro" th:selected="${css == 'claro'}">Tema Claro</option>
                    <option value="escuro" th:selected="${css == 'escuro'}">Tema Escuro</option>
                </select>
                <input type="submit" value="OK"/>
            </form>

            <ul>
                <li th:each="filme : ${filmes}">
                    <a th:href="@{'/filmes/' + ${filme.id}}" th:text="${filme.titulo}"></a>
                </li>
            </ul>

            <div class="text-end mb-3">
                <button id="btnNovo" class="btn btn-primary">+ Novo Filme</button>
            </div>

            <table id="tabelaFilmes" class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Título</th>
                        <th>Gênero</th>
                        <th>Ano</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- preenchido dinamicamente via jQuery -->
                </tbody>
            </table>
        </div>

        <div class="modal fade" id="modalFilme" tabindex="-1" aria-labelledby="modalFilmeLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalFilmeLabel">Novo Filme</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formFilme">
                            <input type="hidden" id="filmeId">
                            <div class="mb-3">
                                <label for="titulo" class="form-label">Título</label>
                                <input type="text" class="form-control" id="titulo" required>
                            </div>
                            <div class="mb-3">
                                <label for="genero" class="form-label">Gênero</label>
                                <input type="text" class="form-control" id="genero" required>
                            </div>
                            <div class="mb-3">
                                <label for="anoLancamento" class="form-label">Ano de Lançamento</label>
                                <input type="number" class="form-control" id="anoLancamento" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" id="btnSalvar" class="btn btn-success">Salvar</button>
                    </div>
                </div>
            </div>
        </div>


        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            $(document).ready(function () {
                const apiUrl = "http://localhost:8080/api/filmes";
                const modal = new bootstrap.Modal(document.getElementById('modalFilme'));
                // Carrega lista de filmes
                function carregarFilmes() {
                    $.get(apiUrl, function (filmes) {
                        let tbody = $("#tabelaFilmes tbody");
                        tbody.empty();
                        filmes.forEach(filme => {
                            tbody.append(`
                    <tr>
                        <td>${filme.id}</td>
                        <td>${filme.titulo}</td>
                        <td>${filme.genero}</td>
                        <td>${filme.anoLancamento}</td>
                        <td>
                            <a href="detalhesFilme.html?id=${filme.id}" class="btn btn-sm btn-info text-white">
                                Detalhes / Análises
                            </a>
                            <button class="btn btn-sm btn-warning editar" data-id="${filme.id}">Editar</button>
                            <button class="btn btn-sm btn-danger excluir" data-id="${filme.id}">Excluir</button>
                        </td>
                    </tr>
                `);
                        });
                    });
                }

                carregarFilmes();

                // Botão "Novo Filme"
                $("#btnNovo").click(function () {
                    $("#filmeId").val("");
                    $("#titulo").val("");
                    $("#genero").val("");
                    $("#anoLancamento").val("");
                    $("#modalFilmeLabel").text("Novo Filme");
                    modal.show();
                });
                // Botão "Salvar"
                $("#btnSalvar").click(function () {
                    const filme = {
                        titulo: $("#titulo").val(),
                        genero: $("#genero").val(),
                        anoLancamento: parseInt($("#anoLancamento").val())
                    };
                    const id = $("#filmeId").val();
                    if (id) {
                        // PUT
                        $.ajax({
                            url: apiUrl + "/" + id,
                            method: "PUT",
                            contentType: "application/json",
                            data: JSON.stringify(filme),
                            success: function () {
                                modal.hide();
                                carregarFilmes();
                            }
                        });
                    } else {
                        // POST
                        $.ajax({
                            url: apiUrl,
                            method: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(filme),
                            success: function () {
                                modal.hide();
                                carregarFilmes();
                            }
                        });
                    }
                });
                // Editar filme
                $(document).on("click", ".editar", function () {
                    const id = $(this).data("id");
                    $.get(apiUrl + "/" + id, function (filme) {
                        $("#filmeId").val(filme.id);
                        $("#titulo").val(filme.titulo);
                        $("#genero").val(filme.genero);
                        $("#anoLancamento").val(filme.anoLancamento);
                        $("#modalFilmeLabel").text("Editar Filme");
                        modal.show();
                    });
                });

                // Excluir filme
                $(document).on("click", ".excluir", function () {
                    const id = $(this).data("id");
                    if (confirm("Tem certeza que deseja excluir este filme?")) {
                        $.ajax({
                            url: `${apiUrl}/${id}`,
                            type: "DELETE",
                            success: function () {
                                alert("Filme excluído com sucesso!");
                                carregarFilmes(); // atualiza a tabela
                            },
                            error: function (xhr) {
                                alert("Erro ao excluir o filme: " + xhr.responseText);
                            }
                        });
                    }
                });
            });
        </script>

    </body>
</html>